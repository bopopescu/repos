Index: cel_qnorm_pass1.cpp
===================================================================
RCS file: /home/hin-tak/cvs-root/C/fileparser/CelQuantileNorm/cel_qnorm_pass1.cpp,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -r1.2 -r1.3
--- cel_qnorm_pass1.cpp	21 Sep 2006 11:04:59 -0000	1.2
+++ cel_qnorm_pass1.cpp	1 Nov 2006 01:26:19 -0000	1.3
@@ -25,6 +25,7 @@
 #include <iostream>
 //#include <cstdlib>
 //#include <algorithm>
+#include <cmath>
 #include "CELFileData.h"
 #include "stable_compare.h"
 
@@ -101,7 +102,7 @@
       qsort(intensity, CEL_INTENSITY_ARRAY_SIZE, sizeof(float), stable_compare_float);
 
       for (int icel=0; icel< CEL_INTENSITY_ARRAY_SIZE; icel++)
-	sum[icel] += intensity[icel];
+	sum[icel] += log(intensity[icel]);
 
       read_count++;
       cel.Close();
Index: log_average.cpp
===================================================================
RCS file: /home/hin-tak/cvs-root/C/fileparser/CelQuantileNorm/log_average.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -r1.3 -r1.4
--- log_average.cpp	15 Sep 2006 14:54:17 -0000	1.3
+++ log_average.cpp	1 Nov 2006 01:26:19 -0000	1.4
@@ -9,13 +9,9 @@
      for(int m=0; m < N_MATCH_TYPES; m++) {
   */
   for(int pq=0; pq < count[0][0]; pq++) {
-    double M_il = (log(intensity[0][1][pq]) + log(intensity[1][1][pq]))/2.0;
-    if ( intensity[0][0][pq] > intensity[0][1][pq] ) {
-      vA_il += (log(intensity[0][0][pq]) -  M_il);
-    } /* else add nothing */
-    if ( intensity[1][0][pq] > intensity[1][1][pq] ) {
-      vB_il += (log(intensity[1][0][pq]) - M_il);
-    } /* else add nothing */
+    double M_il = ((intensity[0][1][pq]) + (intensity[1][1][pq]))/2.0;
+      vA_il += ((intensity[0][0][pq]) - M_il);
+      vB_il += ((intensity[1][0][pq]) - M_il);
   }
   
   *A_il = vA_il / count[0][0];
