<%inherit file="/base.html"/>

<%def name="title()">Select Genome-Wide Association</%def>

${h.form(h.url_for(), method='get', onsubmit="return handleResponse('%s')"%h.url_for(controller="DisplayResults", action='showOne', id=None) )}

<!-- ${h.checkbox('remove_old_plots')} Remove Old Plots<br />	<!-- 2009-1-29 Note: no way to set checkbox default to checked here. do it in the controller's defaults. --> 
Call Method: ${h.select('call_method_id', selected_values=[], options=c.call_method_ls, onchange="SelectChange('%s', ['call_method_id'], 'phenotype_method_id'); return false;"%(
	h.url_for(controller="DisplayResults", action="getPhenotypeMethodLsJson", id=None)
	), required=True )}  <br/>

Phenotype Method: ${h.select('phenotype_method_id', selected_values=[], options=[], onchange="SelectChange('%s', ['call_method_id', 'phenotype_method_id'], 'analysis_method_id'); return false;"%(
	h.url_for(controller="DisplayResults", action="getAnalysisMethodLsJson", id=None)
	), required=True)}  <br />

Analysis Method: ${h.select('analysis_method_id', selected_values=[], options=[], 
	onchange="return handleResponse('%s', ['call_method_id', 'phenotype_method_id', 'analysis_method_id'])"%(h.url_for(controller="DisplayResults", action='fetchOne', id=None)),
	required=True)}<br />


${h.hidden('results_id', id='results_id')}
<!-- ${h.submit('submit', 'Submit')} -->
${h.end_form()}

<div id='display_static_plots'>
	<table border=0>
		<tr>
			<td><div id="display_hist_thumb" style="display:none"></div></td>
			<td><div id="display_hist_log_thumb" style="display:none"></div></td>
			<td><div id="display_qq_thumb" style="display:none"></div></td>
			<td><div id="display_qq_log_thumb" style="display:none"></div></td>
		</tr>
	</table>
</div>

<div id='display_gwr'>
<table border=0>
	<tr>
		<td>
		<table border=0>
			% for i in range(5):
					<tr>
						<td><div id="${"display_chr%s"%(i+1)}" style="display:none"></div></td>
					</tr>
			% endfor
		</table>
		</td>
		
		<td style="width: 50%;">
		</td>
		
	</tr>
</table>
</div>

<div id="display_general" style="display:none"></div>

		<table border=0>
			<tr>
				<td><div id="phenotype_hist_div" style="display:none"></div></td>
			</tr>
			<tr>
				<td><div id="pca_select_div" style="display:none"></div></td>
			</tr>
			<tr>
				<td><div id="strain_pca_div" style="display:none"></div></td>
				<td><div id="strain_map_div" style="width: 500px; height: 300;"></div></td>
			</tr>
		</table>
<div id="strain_motion_chart_div" style="display:none"></div>

${self.js()}

<%def name="js()">
	<script src="http://ajax.googleapis.com/ajax/libs/yui/2.6.0/build/yahoo-dom-event/yahoo-dom-event.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/yui/2.6.0/build/connection/connection-min.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/yui/2.6.0/build/json/json-min.js" type="text/javascript"></script>
	<script src="/scripts/form.js"></script>
	<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAEN_qS1l219tT8Orrr7RzDhQCBCvPop-R7bJnP7PY0srByCgosRQws_R88YrzkpUPFgf7qkOEdOwXAQ"
		type="text/javascript"></script>
	<script type="text/javascript">
	var displayResultsSpace = {};
	//02/17/09 initial values
	displayResultsSpace.call_method_id = null;
	displayResultsSpace.phenotype_method_id = null;
	displayResultsSpace.analysis_method_id = null;
	displayResultsSpace.static_plot_name_arr = [['getPhenotypeHistImage','hist_thumb'],
			['getPhenotypeHistImage','hist_log_thumb'],
			['getCallPhenotypeQQImage', 'qq_thumb'],
			['getCallPhenotypeQQImage', 'qq_log_thumb']]
	
	google.load("visualization", "1", {packages:["scatterchart", 'map', 'motionchart']});

	// The selection handler.
	// Loop through all items in the selection and concatenate
	// a single message from all of them.
	
	function generate_handler(chr){
		return function(e) {
			this.chr = chr;
			//var elTarget = YAHOO.util.Event.getTarget(e);		//infer dom element from regular event
			//var chr = elTarget.id[elTarget.id.length-1];
			//alert(arguments.length);
			//alert(arguments[0]);
			//alert(this.chr);
			var selection = chr2chart[this.chr].getSelection();
			if (selection.length>0){
				var item = selection[0];
				var position = chr2data[this.chr].getValue(item.row, 0);
				//alert('You selected chr='+this.chr +" pos="+position);
				var start_pos = position-10000;
				var stop_pos = position+10000;
				var track_id = field_value_ls.join("_");
				window.open("http://mahogany.usc.edu/cgi-bin/gbrowse/arabidopsis1/?start="+start_pos+";stop="+stop_pos+";ref=Chr"+this.chr+";width=640;version=100;cache=on;drag_and_drop=on;show_tooltips=on;grid=on;label=BAC-ProteinCoding-Pseudogene-TEGenes-"+track_id+"-"+track_id+"_SNP");
				//chr2chart[this.chr].setSelection([{row:null, column:null}]);
			}
		};
	}
	
	//2009-1-30 construct a handler for each chromosome, each handler is aware of the chromosome it corresponds to.
	//	used later to addListener()
	var no_of_chrs = 5;
	chr2handler = {};
	for (var i=0; i<no_of_chrs; i++) {
		var chr = i+1;
		chr2handler[chr] = generate_handler(chr);
		}
	
	//2009-1-29 establish the click event handler to each chromosome region. The selectHandler for google visualization can't distinguish which visualization gets clicked.  	
	//YAHOO.util.Event.addListener("display_general", "click", clickHandler);
	
	function drawGWChart(o)
	{
		var chr2div = {};
		chr2chart = {};
		chr2data = {};
   	var no_of_chrs = 5;
		//var remove_old_plots = YAHOO.util.Dom.get('remove_old_plots').value;
		var server_data = YAHOO.lang.JSON.parse(o.responseText);
		//var server_data = o.responseText;
   	var titleY = '-log Pvalue';
   	for (var i=0; i<no_of_chrs; i++) {
   		var chr = i+1;
   		chr2div[chr] = YAHOO.util.Dom.get('display_chr'+chr);
   		//if (remove_old_plots==="on")
   		//{
   		removeChildNodes(chr2div[chr]);
   		chr2chart[chr] = new google.visualization.ScatterChart(chr2div[chr]);
   		chr2data[chr] = new google.visualization.DataTable( eval("("+server_data[chr]+")"), 0.5);
   		
			chr2chart[chr].draw(chr2data[chr], {width: 700, height: 200, titleX: 'Chr'+chr, titleY: titleY, legend: 'none', pointSize: 3});
			chr2div[chr].style.display = 'block';
			google.visualization.events.addListener(chr2chart[chr], 'select', chr2handler[chr]);	//2009-1-29 use the clickHandler to each chr division
   		//chr2data[chr] = new google.visualization.DataTable();
			//chr2data[chr].addColumn('number', 'Position');
			//chr2data[chr].addColumn('number', '-log Pvalue');
   	}
   	//<!--
		//var server_data = YAHOO.lang.JSON.parse(o.responseText);
		//for (var i=0; i<server_data.gwr.length; i++) {
		//	var chr = server_data.gwr[i].chromosome;
		//	var data_index = chr2data[chr].addRow();
		//	chr2data[chr].setValue(data_index, 0, server_data.gwr[i].position);
		//	chr2data[chr].setValue(data_index, 1, server_data.gwr[i].value);
		//}
		//-->
	}
	
	function showCallInfoData(o)
	{
		//if (response.isError()) {
		//	alert('Error in call info query')
		//}
		//var response = YAHOO.lang.JSON.parse(o.responseText);
		var response = o.responseText;
		//var callInfoData = response.getDataTable();
		var callInfoData = new google.visualization.DataTable(eval("("+response+")"), 0.5);
		var strain_pca_div = document.getElementById('strain_pca_div');
		removeChildNodes(strain_pca_div);
		var strain_pca_chart = new google.visualization.ScatterChart(strain_pca_div);
		var pcaView = new google.visualization.DataView(callInfoData);
		pcaView.setColumns([7,6]);
		//alert("pcaView with "+pcaView.getNumberOfRows()+" rows and "+pcaView.getNumberOfColumns()+" cols.");
		strain_pca_chart.draw(pcaView, {width: 500, height: 300, titleX: 'PC2', titleY: 'PC1', legend: 'none', pointSize: 2});
		strain_pca_div.style.display = 'block';
		
		var geoView = new google.visualization.DataView(callInfoData);		
		geoView.setColumns([3,4,2]);
		var strain_map_div = document.getElementById('strain_map_div');
		var map = new google.visualization.Map(strain_map_div);
		map.draw(geoView, {showTip:true, enableScrollWheel:true});
		strain_map_div.style.display = 'block';
		
		// Set a 'select' event listener for the strain_pca_chart.
		// When the strain_pca_chart is selected,
		// we set the selection on the map.
		google.visualization.events.addListener(strain_pca_chart, 'select',
			function() {
				var selection = strain_pca_chart.getSelection();	// 2/3/09 scatter chart selection has non-null row&col
				for (var i=0; i<selection.length; i++){
					selection[i].column=null;	// 2/3/09 set col to null to be compatible with Map selection
					var item = selection[i];
					var label = callInfoData.getValue(item.row, 2);
					var pca_select_div = YAHOO.util.Dom.get('pca_select_div');
					pca_select_div.innerHTML = label;
					pca_select_div.style.display = 'block';
				}
				map.setSelection(selection);
			});

		// Set a 'select' event listener for the map.
		// When the map is selected,
		// we set the selection on the strain_pca_chart.
		google.visualization.events.addListener(map, 'select',
			function() {
				var selection = map.getSelection();	// 2/3/09 map selection row only 
				for (var i=0; i<selection.length; i++){
					selection[i].column=1;	// 2/3/09 set the column index to be compatible with strain_pca_chart selection
				}
				strain_pca_chart.setSelection(selection);
		});
		
		var motionView = new google.visualization.DataView(callInfoData);		
		motionView.setColumns([2,0,4,3,8,5,6,7]);
		var strain_motion_chart_div = document.getElementById('strain_motion_chart_div');
		var strain_motion_chart = new google.visualization.MotionChart(strain_motion_chart_div);
		strain_motion_chart.draw(motionView, {width: 1000, height:700});
		strain_motion_chart_div.style.display = 'block';

	}
	
	function handleResponse(url, field_ls) {
		var callback = {
				success: function(o) {
					//google.setOnLoadCallback(drawGWChart(o));
					drawGWChart(o);
				},
				failure: function(o) {
					alert("Failed to retrieve GenomeWideAssociation information.");
				}
		}
		var url_query = "";
		field_value_ls = new Array();
		for (var i = 0; i < field_ls.length; i += 1) {
			field = field_ls[i];
			if (i!=0){
				url_query = url_query + '&';
			}
			url_query = url_query + field + '=' + YAHOO.util.Dom.get(field).value;
			field_value_ls.push(YAHOO.util.Dom.get(field).value);
			//url = url +'?'+field+'='+YAHOO.util.Dom.get(field).value;
		}
		url = url +'?' + url_query;
		
		var transaction = YAHOO.util.Connect.asyncRequest('GET', url, callback, null);
		
		var display_general = YAHOO.util.Dom.get('display_general');
		display_general.innerHTML = field_value_ls.join(" ");
		display_general.style.display = 'block';
		
		displayResultsSpace.callInfoQueryURL = "${h.url_for(controller='DisplayResults', action='fetchCallInfoData', id=None)}"+'?'+url_query;
						//2009-2-3 same query, but analysis_method_id is not used.
		var callInfoCallBack = {
				success: function(o) {
					showCallInfoData(o);
				},
				failure: function(o) {
					alert("Failed to retrieve Strain/Phenotype/Geo information.");
				}
		}
		var transaction = YAHOO.util.Connect.asyncRequest('GET', displayResultsSpace.callInfoQueryURL, callInfoCallBack, null);
		
		//var call_info_query = new google.visualization.Query(displayResultsSpace.callInfoQueryURL);	//2009-2-3 google query is slower than yahoo asyncRequest
		//call_info_query.send(showCallInfoData);
		for (var i = 0; i < displayResultsSpace.static_plot_name_arr.length; i+=1){
			var action_name = displayResultsSpace.static_plot_name_arr[i][0];
			var img_type = displayResultsSpace.static_plot_name_arr[i][1];
			var div_name = 'display_'+img_type;
			//02/17/09 test if necessary to update plots			
			if (action_name==="getPhenotypeHistImage"){
				if (displayResultsSpace.phenotype_method_id===YAHOO.util.Dom.get("phenotype_method_id").value){
					continue;
				}
				displayResultsSpace.imgQueryURL = "${h.url_for(controller='DisplayResults', action='getPhenotypeHistImage', id=None)}"+'?'+url_query+'&img_type='+img_type;
			}
			else if (action_name==="getCallPhenotypeQQImage"){
				if (displayResultsSpace.phenotype_method_id===YAHOO.util.Dom.get("phenotype_method_id").value && displayResultsSpace.call_method_id===YAHOO.util.Dom.get("call_method_id").value ){
					continue;
				}
				displayResultsSpace.imgQueryURL = "${h.url_for(controller='DisplayResults', action='getCallPhenotypeQQImage', id=None)}"+'?'+url_query+'&img_type='+img_type;
			}
			var replace_elem = document.getElementById(div_name);
			replace_elem.innerHTML = "<a href="+displayResultsSpace.imgQueryURL+"><img src="+displayResultsSpace.imgQueryURL+"></a>";
			replace_elem.style.display = 'block';
			//displayStaticPlot(displayResultsSpace.imgQueryURL, div_name);
		}
		displayResultsSpace.phenotype_method_id=YAHOO.util.Dom.get("phenotype_method_id").value;
		displayResultsSpace.call_method_id=YAHOO.util.Dom.get("call_method_id").value;
		return false;	<!-- 2008-12-30 return false to prevent form action 'server.html' from being invoked-->
	}
	</script>

</%def>